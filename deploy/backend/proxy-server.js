const express = require('express');
const { createProxyMiddleware } = require('http-proxy-middleware');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 80;

// Ð¡Ñ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð°
app.use(express.static(path.join(__dirname, '../public_html')));

// ÐŸÑ€Ð¾ÐºÑÐ¸ Ð´Ð»Ñ API Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
app.use('/api', createProxyMiddleware({
  target: 'http://localhost:3001',
  changeOrigin: true,
  onError: (err, req, res) => {
    console.error('Proxy error:', err);
    res.status(500).json({ error: 'Proxy error' });
  }
}));

// Ð’ÑÐµ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð° Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, '../public_html', 'index.html'));
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
app.listen(PORT, '0.0.0.0', () => {
  console.log(`ðŸš€ Proxy server Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
  console.log(`ðŸŒ Ð”Ð¾Ð¼ÐµÐ½: 53089.tw1.ru`);
  console.log(`ðŸ“¡ ÐŸÑ€Ð¾ÐºÑÐ¸Ñ€ÑƒÐµÑ‚ API Ð½Ð° localhost:3001`);
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
process.on('unhandledRejection', (err) => {
  console.error('UNHANDLED REJECTION! ðŸ’¥ Shutting down...', err);
  process.exit(1);
});
